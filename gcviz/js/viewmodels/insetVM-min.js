(function(){define(["jquery","knockout","gcviz-i18n","gcviz-ko","jqueryslide","magnificpopup","gcviz-func","gcviz-gismap"],function(e,m,o,k,b,g,f,i){var d,a,l,h,n,c,j;d=function(s,q,p){var r=function(z,x,w){var t=this,A=[locationPath+"gcviz/images/insetPrevious.png",locationPath+"gcviz/images/insetNext.png",locationPath+"gcviz/images/insetPlay.png",locationPath+"gcviz/images/insetStop.png"],v=locationPath+"gcviz/images/insetLightbox.png",y=locationPath+"gcviz/images/insetPlayVideo.png",u=vmArray[x].header.headerHeight;t.imgLightbox=v;t.imgPlayVideo=y;t.tpLight=o.getDict("%inset-tplight");t.tpPlayVideo=o.getDict("%inset-tpPlayVideo");t.bottom=parseInt(z.css("bottom"),10);t.left=parseInt(z.css("left"),10);t.height=parseInt(z.css("height"),10);t.width=parseInt(z.css("width"),10);t.size=w.size;t.type=w.type;t.fullscreen=w.fullscreen;t.VisibleState=true;t.fullscreenState=false;t.mapid=x;t.init=function(){var B=t.type;if(B==="image"){l(z,t,A)}else{if(B==="video"){h(z,t)}else{if(B==="map"){t.map=c(z,w,t)}else{if(B==="html"){n(z,w)}}}}return{controlsDescendantBindings:true}};t.insetClick=function(C,B){z.find("a")[0].click()};t.videoClick=function(E,C){var B=z[0].getElementsByTagName("Video")[0],D=z.find(".gcviz-play-background");if(B.paused){D.addClass("gcviz-hidden");B.play();B.tabIndex=0;B.focus()}else{B.pause();B.tabIndex="";D.removeClass("gcviz-hidden")}};t.stopVideo=function(D,B,E){var F,G,C;if(D===32){if(E==="keyup"){F=z[0].getElementsByTagName("Video")[0],G=z.find(".gcviz-play-background"),C=z.find(".gcviz-play-button")[0];F.pause();F.tabIndex=-1;F.blur();G.removeClass("gcviz-hidden");setTimeout(function(){C.focus()},100);return true}else{return true}}return false};t.setVisibility=function(D){var B,C=t.map;if(D){z.removeClass("gcviz-hidden");t.VisibleState=true;if(t.type==="map"){if(t.fullscreenState){B=t.fullscreenHeight}else{B=t.height}z.find("#"+z[0].id+"m").css({height:B-20});i.manageScreenState(t.map,1000)}}else{z.addClass("gcviz-hidden");t.VisibleState=false}};t.enterFullscreen=function(G,J){t.fullscreenState=true;if(t.fullscreen){var F=f.getFullscreenParam(G,J),L=F.width,H=F.height,K=F.ratio,I={},B=t.bottom,E=t.left,M=t.height,D=t.width,N,C=t.map;if(t.size==="%"){if(B!==u){I.bottom=((B*K)+((u*K)-u))+"px"}if(E!==0){I.left=(E*K)+"px"}}else{if(B!==u){K=(H/J);I.bottom=((B+M+u)/J)*(H-u-M)+"px"}if(E!==0){K=(L/G);I.left=((E+D)/G)*(L-D)+"px"}}t.fullscreenHeight=M*K;f.setStyle(z[0],I);if(t.type==="map"&&t.VisibleState){z.find("#"+z[0].id+"m").css({height:(M*K)-20});if(C.vType!=="static"){i.resizeMap(C)}else{i.manageScreenState(C,1000)}}}else{z.addClass("gcviz-inset-hidden")}};t.exitFullscreen=function(){t.fullscreenState=false;if(t.fullscreen){var B,C=t.map;f.setStyle(z[0],{bottom:t.bottom+"px",left:t.left+"px"});if(t.type==="map"&&t.VisibleState){z.find("#"+z[0].id+"m").css({height:t.height-20});if(C.vType!=="static"){i.resizeMap(C)}else{i.manageScreenState(C,1000)}}}else{z.removeClass("gcviz-inset-hidden")}};t.applyKey=function(D,C){var E=t.map,B=false;if(D===37){i.panLeft(E);B=true}else{if(D===38){i.panUp(E);B=true}else{if(D===39){i.panRight(E);B=true}else{if(D===40){i.panDown(E);B=true}}}}return B};t.init()};a=new r(s,q,p);m.applyBindings(a,s[0]);return a};l=function(r,v,x){var p=r.vSource,s=p.length,u,q,t,w;v.img=[];while(s--){if(p[s].location==="internet"){v.img[s]=p[s].url}else{v.img[s]=locationPath+p[s].url}}if(p.length>1){u=".slidesjs-container";e("#"+r.attr("id").replace("inset","slides")).slidesjs({height:v.height-50,width:v.width,navigation:{effect:"fade"},pagination:{effect:"fade"},effect:{fade:{speed:400}},play:{active:true,effect:"slide",interval:5000,auto:true,swap:true,pauseOnHover:false,restartDelay:2500}})}else{u="."+r.attr("id")}j("image",r,null,u,null);q=r.find("a");s=q.length;while(s--){t=q[s];w=e(t);if(!w.hasClass("slidesjs-navigation")){t.tabIndex=-1}else{t.tabIndex=0;t.innerText="";t.innerHTML="";w.addClass("gcviz-inset-button");if(w.hasClass("slidesjs-previous")){w.append('<img class="gcviz-imginset-button" src="'+x[0]+'" />')}else{if(w.hasClass("slidesjs-next")){w.append('<img class="gcviz-imginset-button" src="'+x[1]+'" />')}else{if(w.hasClass("slidesjs-play")){w.append('<img class="gcviz-imginset-button" src="'+x[2]+'" />')}else{if(w.hasClass("slidesjs-stop")){w.append('<img class="gcviz-imginset-button" src="'+x[3]+'" />')}}}}}}};h=function(q,p){var u=q.vSource,t=u.length,w="#"+q[0].id+"v",s=e(w),v=q.find(".gcviz-play-background"),r={beforeOpen:function(){s.find("video").height((window.innerHeight*0.8));v.addClass("gcviz-hidden")},close:function(){s.find("video")[0].pause();v.removeClass("gcviz-hidden")}};p.vid=[];while(t--){if(u[t].location==="internet"){p.vid[t]=u[t].url}else{p.vid[t]=locationPath+u[t].url}}j("inline",q,s,w,r)};n=function(q,p){var r=p.inset.type,u="#"+q[0].id+"h",t=e(u),s={beforeOpen:null,close:null};j("inline",q,t,u,s)};c=function(r,E,v){var C=E.inset,z=C.layers.length,s=C.layers,B=r[0].id,p,x=e("#"+B.replace("inset","load")),u=B+"m",A=window.innerHeight*0.8,y,q="#"+u,D=e(q),w;p=i.createInset(u,C,v.mapid);s=s.reverse();while(z--){var t=s[z];i.addLayer(p,t.type,t.url)}if(E.inset.type!=="static"){if(E.inset.typeinfo.pan){D[0].tabIndex=0}}r.find(".mp-link").magnificPopup({items:{src:q,type:"inline"},callbacks:{beforeOpen:function(){w=r.find(q).css("height");y=i.getMapCenter(p);D.addClass("mp-inset");D.height(A);x.addClass("gcviz-load-open");x.removeClass("gcviz-hidden")},open:function(){i.resizeMap(p);var F={point:y,interval:700};i.resizeCenterMap(p,F)},change:function(){setTimeout(function(){x.addClass("gcviz-hidden")},2000)},beforeClose:function(){x.removeClass("gcviz-load-open");x.removeClass("gcviz-hidden")},close:function(){r.find(q).css({height:w});var F={interval:700};i.resizeCenterMap(p,F)},afterClose:function(){D.removeClass("mfp-hide");D.removeClass("mp-inset");setTimeout(function(){x.addClass("gcviz-hidden")},2000)}},key:"map-key",mainClass:"mfp-with-fade"});return p};j=function(q,p,s,t,r){if(q==="inline"){p.find(".mp-link").magnificPopup({items:{src:t,type:"inline"},callbacks:{beforeOpen:r.beforeOpen,open:function(){s.addClass("mp-inset");var u=s.find("video")[0];if(u){u.play()}},close:r.close,afterClose:function(){s.removeClass("mfp-hide");s.removeClass("mp-inset")}},key:"inline-key",mainClass:"mfp-with-fade"})}else{p.find(t).magnificPopup({delegate:"a",type:"image",key:"image-key",mainClass:"mfp-with-fade",closeOnContentClick:true,gallery:{enabled:true}})}};return{initialize:d}})}).call(this);